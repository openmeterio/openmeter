# OpenMeter

OpenMeter is a billing and metering platform for AI and DevTool companies, providing usage-based billing, real-time insights, and usage limit enforcement.

## Prerequisites

**Recommended:** Install [Nix](https://nixos.org/download.html) and [direnv](https://direnv.net/docs/installation.html) - the project's `flake.nix` provides all required tools automatically.

**Manual setup:** Go 1.23+, Docker, librdkafka, Node.js (for TypeSpec), Atlas CLI (for migrations).

## Quick Start

```bash
# Start dependencies
make up

# Run the server (hot-reload)
make server

# In another terminal, run tests
make test
```

Configuration is loaded from `config.yaml` (see `config.example.yaml` for reference).

## Project Layout

```
api/              # API definitions and generated code
  spec/src/       # TypeSpec source files
  client/         # Generated SDKs (Go, JS, Python)
  v3/             # v3 API handlers and generated code
app/              # Application wiring (Wire providers)
cmd/              # Service entry points
openmeter/        # Core business logic packages
pkg/              # Shared utilities
tools/migrate/    # Database migrations
e2e/              # End-to-end tests
```

## Build & Development Commands

Development commands are run via `Makefile`. Dagger and justfile are also present but seldom used.

```bash
# Start dependencies (postgres, kafka, clickhouse)
make up

# Start all services including optional ones (redis, svix, dev UIs)
COMPOSE_PROFILES=dev,redis,webhook make up

# Run services with hot-reload (uses air)
make server
make sink-worker
make balance-worker
make billing-worker
make notification-service

# Build all binaries
make build

# Build specific binary
make build-server

# Run all tests (requires postgres running)
make test
make test-nocache  # bypass test cache

# Run e2e tests (starts its own docker dependencies)
make etoe

# Linting
make lint
make lint-go      # just Go
make fmt          # auto-fix lint issues

# Code generation
make generate     # go generate (ent schemas, wire DI)
make gen-api      # TypeSpec -> OpenAPI -> Go/JS clients
```

## Testing

To run all tests, invoke `make test` or `make test-nocache` if you want to bypass the test cache.

When running tests directly (not via Make), ensure the environment is set correctly. See `Makefile`'s `test` command or `.vscode/settings.json` `go.testEnvVars`.

```bash
docker compose up -d postgres
TZ=UTC POSTGRES_HOST=127.0.0.1 go test -tags=dynamic -p 128 -parallel 16 ./...
```

For a single test:
```bash
TZ=UTC POSTGRES_HOST=127.0.0.1 go test -tags=dynamic -run TestName ./path/to/package
```

The `-tags=dynamic` flag is required to build against local librdkafka.

E2E tests are run via `make etoe` - they are API tests that need to start dependencies via docker compose, always invoke them via Make.

## Code Generation

Never edit generated files manually:

- `api/openapi.yaml`, `api/v3/openapi.yaml` - Generated from TypeSpec in `api/spec/src/`
- `api/api.gen.go`, `api/v3/api.gen.go` - Generated from OpenAPI via oapi-codegen
- `api/client/` - Generated SDK clients
- `openmeter/ent/db/` - Generated from ent schemas in `openmeter/ent/schema/`
- `cmd/*/wire_gen.go` - Generated by Wire from `wire.go` files

Regeneration commands:
```bash
make gen-api       # TypeSpec -> OpenAPI -> clients
make generate      # ent + wire
```

## Database Migrations

Uses Atlas with ent schema as source:
```bash
# Generate a new migration after changing ent schema
atlas migrate --env local diff <migration-name>
```

Migrations are stored in `tools/migrate/migrations/`.

## Architecture

### Service Binaries (`cmd/`)

- **server** - Main API server
- **sink-worker** - Processes ingested events from Kafka into ClickHouse
- **balance-worker** - Manages entitlement balances
- **billing-worker** - Processes billing operations
- **notification-service** - Handles notifications via webhooks
- **benthos-collector** - Data collection pipeline
- **jobs** - Background job runner

### Core Packages (`openmeter/`)

Domain-driven packages:
- `billing/` - Invoicing and billing profiles
- `customer/` - Customer management
- `entitlement/` - Usage entitlements and grants
- `productcatalog/` - Plans, features, addons
- `subscription/` - Subscription lifecycle
- `meter/` - Meter definitions
- `streaming/` - ClickHouse query layer for usage data
- `ingest/` - Event ingestion (Kafka)
- `notification/` - Webhooks via Svix
- `app/` - App marketplace (Stripe integration, etc.)

Infrastructure:
- `ent/` - Database schema and generated ORM
- `server/` - HTTP router and middleware

### Dependency Injection

Uses Google Wire. Each service has:
- `wire.go` - Provider definitions (build tag: `wireinject`)
- `wire_gen.go` - Generated code

### API Layers

1. **TypeSpec** (`api/spec/src/`) - API definition language
2. **OpenAPI** (`api/openapi.yaml`, `api/v3/openapi.yaml`) - Generated specs
3. **Go handlers** - `api/` (v1) and `api/v3/handlers/` (v3)

### Storage

- **PostgreSQL** - Primary database via ent ORM
- **ClickHouse** - Time-series usage data
- **Kafka** - Event streaming
- **Redis** - Caching (optional)

## Go Build Tags

Required for development:
- `dynamic` - Build against local librdkafka
- `wireinject` - Include wire provider definitions

VSCode/IDE settings: `"go.buildTags": "wireinject,dynamic"`

## Key Domain Concepts

- **Meter** - Defines how to aggregate events (e.g., sum of API calls, unique users)
- **Event** - CloudEvents-format usage data ingested via Kafka
- **Feature** - A capability that can be metered and entitled
- **Entitlement** - Grants a customer access to a feature with optional limits
- **Grant** - Credits/allowance added to an entitlement balance
- **Plan** - A bundle of features with pricing, used for subscriptions
- **Subscription** - Links a customer to a plan with billing lifecycle
- **Billing Profile** - Configuration for invoicing (apps for tax, invoicing, payment)
- **App** - Integration with external services (Stripe, Svix, custom invoicing)
