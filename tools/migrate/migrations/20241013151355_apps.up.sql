-- create "apps" table
CREATE TABLE "apps" (
  "id" character(26) NOT NULL,
  "namespace" character varying NOT NULL,
  "metadata" jsonb NULL,
  "created_at" timestamptz NOT NULL,
  "updated_at" timestamptz NOT NULL,
  "deleted_at" timestamptz NULL,
  "name" character varying NOT NULL,
  "description" character varying NOT NULL,
  "type" character varying NOT NULL,
  "status" character varying NOT NULL,
  "is_default" boolean NOT NULL DEFAULT false,
  PRIMARY KEY ("id")
);
-- create index "app_id" to table: "apps"
CREATE UNIQUE INDEX "app_id" ON "apps" ("id");
-- create index "app_namespace" to table: "apps"
CREATE INDEX "app_namespace" ON "apps" ("namespace");
-- create index "app_namespace_id" to table: "apps"
CREATE UNIQUE INDEX "app_namespace_id" ON "apps" ("namespace", "id");
-- create index "app_namespace_type" to table: "apps"
CREATE INDEX "app_namespace_type" ON "apps" ("namespace", "type");
-- create index "app_namespace_type_is_default" to table: "apps"
CREATE UNIQUE INDEX "app_namespace_type_is_default" ON "apps" ("namespace", "type", "is_default") WHERE (is_default = true);
-- modify "customers" table
ALTER TABLE "customers" DROP COLUMN "external_mapping_stripe_customer_id";
-- create "app_customers" table
CREATE TABLE "app_customers" (
  "id" bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY,
  "namespace" character varying NOT NULL,
  "created_at" timestamptz NOT NULL,
  "updated_at" timestamptz NOT NULL,
  "deleted_at" timestamptz NULL,
  "app_id" character(26) NOT NULL,
  "customer_id" character(26) NOT NULL,
  PRIMARY KEY ("id"),
  CONSTRAINT "app_customers_apps_customer_apps" FOREIGN KEY ("app_id") REFERENCES "apps" ("id") ON UPDATE NO ACTION ON DELETE CASCADE,
  CONSTRAINT "app_customers_customers_apps" FOREIGN KEY ("customer_id") REFERENCES "customers" ("id") ON UPDATE NO ACTION ON DELETE CASCADE
);
-- create index "appcustomer_namespace" to table: "app_customers"
CREATE INDEX "appcustomer_namespace" ON "app_customers" ("namespace");
-- create index "appcustomer_namespace_app_id_customer_id" to table: "app_customers"
CREATE UNIQUE INDEX "appcustomer_namespace_app_id_customer_id" ON "app_customers" ("namespace", "app_id", "customer_id");
-- create "app_stripes" table
CREATE TABLE "app_stripes" (
  "id" character(26) NOT NULL,
  "namespace" character varying NOT NULL,
  "created_at" timestamptz NOT NULL,
  "updated_at" timestamptz NOT NULL,
  "deleted_at" timestamptz NULL,
  "stripe_account_id" character varying NOT NULL,
  "stripe_livemode" boolean NOT NULL,
  "api_key" character varying NOT NULL,
  "stripe_webhook_id" character varying NOT NULL,
  "webhook_secret" character varying NOT NULL,
  PRIMARY KEY ("id"),
  CONSTRAINT "app_stripes_apps_app" FOREIGN KEY ("id") REFERENCES "apps" ("id") ON UPDATE NO ACTION ON DELETE CASCADE
);
-- create index "appstripe_id" to table: "app_stripes"
CREATE UNIQUE INDEX "appstripe_id" ON "app_stripes" ("id");
-- create index "appstripe_namespace" to table: "app_stripes"
CREATE INDEX "appstripe_namespace" ON "app_stripes" ("namespace");
-- create "app_stripe_customers" table
CREATE TABLE "app_stripe_customers" (
  "id" bigint NOT NULL GENERATED BY DEFAULT AS IDENTITY,
  "namespace" character varying NOT NULL,
  "created_at" timestamptz NOT NULL,
  "updated_at" timestamptz NOT NULL,
  "deleted_at" timestamptz NULL,
  "stripe_customer_id" character varying NOT NULL,
  "stripe_default_payment_method_id" character varying NULL,
  "app_id" character(26) NOT NULL,
  "customer_id" character(26) NOT NULL,
  PRIMARY KEY ("id"),
  CONSTRAINT "app_stripe_customers_app_stripes_customer_apps" FOREIGN KEY ("app_id") REFERENCES "app_stripes" ("id") ON UPDATE NO ACTION ON DELETE CASCADE,
  CONSTRAINT "app_stripe_customers_customers_customer" FOREIGN KEY ("customer_id") REFERENCES "customers" ("id") ON UPDATE NO ACTION ON DELETE CASCADE
);
-- create index "appstripecustomer_app_id_stripe_customer_id" to table: "app_stripe_customers"
CREATE UNIQUE INDEX "appstripecustomer_app_id_stripe_customer_id" ON "app_stripe_customers" ("app_id", "stripe_customer_id");
-- create index "appstripecustomer_namespace" to table: "app_stripe_customers"
CREATE INDEX "appstripecustomer_namespace" ON "app_stripe_customers" ("namespace");
-- create index "appstripecustomer_namespace_app_id_customer_id" to table: "app_stripe_customers"
CREATE UNIQUE INDEX "appstripecustomer_namespace_app_id_customer_id" ON "app_stripe_customers" ("namespace", "app_id", "customer_id");
